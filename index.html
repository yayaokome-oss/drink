import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, onSnapshot, setDoc, query } from 'firebase/firestore';
import { 
  LucideChevronLeft, 
  LucideChevronRight, 
  LucideTrash2, 
  LucideSparkles, 
  LucidePlus, 
  LucideCloud, 
  LucideCalendar, 
  LucideHistory,
  LucideLoader2,
  LucideDatabase,
  LucideLayoutList,
  LucideStore,
  LucideCoffee,
  LucideRecycle,
  LucideTrendingUp,
  LucideDollarSign,
  LucideZap
} from 'lucide-react';

// Firebase é…ç½® (ç”±ç’°å¢ƒè‡ªå‹•æ³¨å…¥)
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'drink-tracker-pro-cloud';

export default function App() {
  const [user, setUser] = useState(null);
  const [dbData, setDbData] = useState({
    "20260101": [{ p: 50, s: "éº»å¤èŒ¶åŠ", i: "ç´…è±çƒé¾+æ³¢éœ¸", ice: "å¾®å†°", sug: "å¾®ç³–", eco: true }],
    "20260103": [{ p: 45, s: "é‡‘èŒ¶ä¼", i: "è•éº¥+çç ", ice: "å¾®å†°", sug: "å¾®ç³–", eco: false }]
  });
  const [currentYear, setCurrentYear] = useState(2026);
  const [currentMonth, setCurrentMonth] = useState(0); 
  const [viewMode, setViewMode] = useState('calendar'); // 'calendar' æˆ– 'list'
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [activeDayKey, setActiveDayKey] = useState("");
  const [aiAnalysis, setAiAnalysis] = useState("");
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [tempRecords, setTempRecords] = useState([]);
  const [syncStatus, setSyncStatus] = useState("pending");

  // è«‹æ³¨æ„ï¼šåœ¨ GitHub Pages ç­‰ç’°å¢ƒä½¿ç”¨æ™‚ï¼Œéœ€ç¢ºä¿æ­¤è™•å¡«å…¥æ­£ç¢ºçš„ Gemini API Key
  const apiKey = ""; 

  // (1) åˆå§‹åŒ– Auth (éµå¾ª Rule 3)
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth Error", err);
        setSyncStatus("error");
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (u) setSyncStatus("synced");
    });
    return () => unsubscribe();
  }, []);

  // (2) ç›£è½ Firestore è³‡æ–™ (éµå¾ª Rule 1)
  useEffect(() => {
    if (!user) return;
    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'all_data');
    
    const unsubscribe = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        const cloudData = docSnap.data().records || {};
        setDbData(prev => ({ ...prev, ...cloudData }));
      }
    }, (err) => {
      console.error("Firestore Listen Error", err);
      setSyncStatus("error");
    });

    return () => unsubscribe();
  }, [user]);

  // --- çµ±è¨ˆé‚è¼¯ ---
  const stats = useMemo(() => {
    const all = Object.values(dbData).flat();
    const totalCost = all.reduce((s, d) => s + (Number(d.p) || 0), 0);
    const ecoCount = all.filter(d => d.eco).length;
    
    const stores = all.map(d => d.s).filter(Boolean);
    const topStoreMap = stores.reduce((acc, curr) => {
      acc[curr] = (acc[curr] || 0) + 1;
      return acc;
    }, {});
    const favoriteStore = Object.keys(topStoreMap).sort((a,b) => topStoreMap[b] - topStoreMap[a])[0] || "å°šæœªç´€éŒ„";

    const items = all.map(d => d.i).filter(Boolean);
    const topItemMap = items.reduce((acc, curr) => {
      acc[curr] = (acc[curr] || 0) + 1;
      return acc;
    }, {});
    const favoriteItem = Object.keys(topItemMap).sort((a,b) => topItemMap[b] - topItemMap[a])[0] || "å°šæœªç´€éŒ„";

    const avgPrice = all.length > 0 ? Math.round(totalCost / all.length) : 0;

    return { total: all.length, cost: totalCost, eco: ecoCount, store: favoriteStore, item: favoriteItem, avg: avgPrice };
  }, [dbData]);

  // --- æ­·å²æ¸…å–®é‚è¼¯ ---
  const historyList = useMemo(() => {
    const list = [];
    Object.keys(dbData).forEach(dateKey => {
      dbData[dateKey].forEach(drink => {
        list.push({ ...drink, date: dateKey });
      });
    });
    return list.sort((a, b) => b.date.localeCompare(a.date));
  }, [dbData]);

  // --- æœˆæ›†é‚è¼¯ ---
  const calendarDays = useMemo(() => {
    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const days = [];
    for (let i = 0; i < firstDay; i++) days.push(null);
    for (let i = 1; i <= daysInMonth; i++) {
      const key = `${currentYear}${String(currentMonth + 1).padStart(2, '0')}${String(i).padStart(2, '0')}`;
      days.push({ day: i, key, drinks: dbData[key] || [] });
    }
    return days;
  }, [currentYear, currentMonth, dbData]);

  const changeMonth = (delta) => {
    let newM = currentMonth + delta;
    let newY = currentYear;
    if (newM > 11) { newM = 0; newY++; }
    if (newM < 0) { newM = 11; newY--; }
    setCurrentMonth(newM);
    setCurrentYear(newY);
  };

  const openEdit = (dayData) => {
    setActiveDayKey(dayData.key);
    setTempRecords(dayData.drinks.length > 0 ? [...dayData.drinks] : [{ p: "", s: "", i: "", ice: "å¾®å†°", sug: "å¾®ç³–", eco: false }]);
    setIsModalOpen(true);
  };

  const saveToCloud = async () => {
    if (!user) return;
    setSyncStatus("pending");
    const newData = { ...dbData, [activeDayKey]: tempRecords.filter(r => r.p !== "" || r.s !== "") };
    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'all_data');
    try {
      await setDoc(docRef, { records: newData, lastUpdated: Date.now() });
      setDbData(newData);
      setSyncStatus("synced");
      setIsModalOpen(false);
    } catch (e) {
      console.error("Save Error", e);
      setSyncStatus("error");
    }
  };

  const callAIAnalysis = async () => {
    if (isAiLoading) return;
    setIsAiLoading(true);
    setAiAnalysis("æ­£åœ¨å›é¡§æ‚¨çš„æ¯ä¸€æ¯ç¾å‘³...");
    const prompt = `é€™æ˜¯æˆ‘åœ¨ 2026 å¹´çš„æ‰‹æ–é£²ç´€éŒ„ï¼š${JSON.stringify(dbData)}ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡çµ¦å‡ºä¸€æ®µå¹½é»˜ä¸”å……æ»¿é¼“å‹µçš„åˆ†æã€‚`;
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const resData = await response.json();
      setAiAnalysis(resData.candidates?.[0]?.content?.parts?.[0]?.text || "åˆ†æå¤±æ•—ã€‚");
    } catch (e) {
      setAiAnalysis("Gemini ç›®å‰å¿™ç·šä¸­ã€‚");
    } finally {
      setIsAiLoading(false);
    }
  };

  const formatDate = (key) => `${key.substring(0,4)}/${key.substring(4,6)}/${key.substring(6,8)}`;

  return (
    <div className="min-h-screen bg-[#F8FAFC] p-4 font-sans text-slate-800 pb-24">
      {/* é ‚éƒ¨ç‹€æ…‹åˆ— */}
      <div className="flex justify-between items-center mb-8">
        <div className="flex bg-white/60 p-1 rounded-2xl border border-white shadow-sm">
          <button 
            onClick={() => setViewMode('calendar')}
            className={`p-2.5 rounded-xl transition-all ${viewMode === 'calendar' ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-400 hover:text-slate-600'}`}
          >
            <LucideCalendar size={18} />
          </button>
          <button 
            onClick={() => setViewMode('list')}
            className={`p-2.5 rounded-xl transition-all ${viewMode === 'list' ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-400 hover:text-slate-600'}`}
          >
            <LucideHistory size={18} />
          </button>
        </div>
        <div className="bg-white/80 px-4 py-1.5 rounded-full border border-white shadow-sm flex items-center gap-2">
          <div className={`w-2 h-2 rounded-full ${syncStatus === 'synced' ? 'bg-emerald-400' : 'bg-amber-400 animate-pulse'}`} />
          <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
            {syncStatus === 'synced' ? 'Cloud Sync' : 'Connecting'}
          </span>
        </div>
      </div>

      <header className="text-center mb-10">
        <span className="text-6xl mb-4 inline-block drop-shadow-md">ğŸ§‹</span>
        <h1 className="text-sm font-black text-slate-400 uppercase tracking-[0.5em] mt-1">Personal Drink Tracker</h1>
      </header>

      {/* å…­å¤§æ•¸æ“šçœ‹æ¿ (æ–°ç‰ˆè¨­è¨ˆ) */}
      <div className="grid grid-cols-3 gap-3 mb-8">
        {/* Row 1: è³ªæ€§æ•¸æ“š */}
        <div className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex flex-col items-center">
          <LucideStore size={14} className="text-purple-400 mb-2" />
          <p className="text-[9px] font-bold text-slate-400 uppercase mb-1">æœ€æ„›åº—å®¶</p>
          <p className="text-[11px] font-black text-slate-700 truncate w-full text-center">{stats.store}</p>
        </div>
        <div className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex flex-col items-center">
          <LucideCoffee size={14} className="text-pink-400 mb-2" />
          <p className="text-[9px] font-bold text-slate-400 uppercase mb-1">æœ€æ„›å“é …</p>
          <p className="text-[11px] font-black text-slate-700 truncate w-full text-center">{stats.item}</p>
        </div>
        <div className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex flex-col items-center">
          <LucideRecycle size={14} className="text-emerald-400 mb-2" />
          <p className="text-[9px] font-bold text-slate-400 uppercase mb-1">æ¸›å¡‘æˆå°±</p>
          <p className="text-[11px] font-black text-slate-700">{stats.eco} æ¬¡</p>
        </div>
        {/* Row 2: é‡åŒ–æ•¸æ“š */}
        <div className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex flex-col items-center">
          <p className="text-[9px] font-bold text-slate-400 uppercase mb-1">ç¸½æ¯æ•¸</p>
          <p className="text-xl font-black text-slate-800">{stats.total}</p>
        </div>
        <div className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex flex-col items-center">
          <p className="text-[9px] font-black text-emerald-500 uppercase mb-1">ç¸½é‡‘é¡</p>
          <p className="text-xl font-black text-emerald-600">${stats.cost}</p>
        </div>
        <div className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex flex-col items-center">
          <p className="text-[9px] font-bold text-slate-400 uppercase mb-1">å¹³å‡åƒ¹</p>
          <p className="text-xl font-black text-blue-500">${stats.avg}</p>
        </div>
      </div>

      {/* AI æŒ‰éˆ• (æ·ºè‰²é€²åŒ–ç‰ˆ) */}
      <button 
        onClick={callAIAnalysis}
        className="w-full bg-gradient-to-br from-indigo-50 to-purple-50 border border-indigo-100 mb-10 p-6 rounded-[2.5rem] flex items-center justify-between shadow-sm active:scale-[0.98] transition-all disabled:opacity-50"
        disabled={isAiLoading}
      >
        <div className="flex items-center gap-5">
          <div className="bg-white p-3 rounded-2xl shadow-sm">
            {isAiLoading ? <LucideLoader2 className="text-indigo-500 animate-spin" size={24} /> : <LucideSparkles className="text-indigo-500" size={24} />}
          </div>
          <div className="text-left">
            <p className="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">AI Analysis</p>
            <p className="font-black text-lg text-slate-600">Gemini é£²å“ç”Ÿæ´»åˆ†æ</p>
          </div>
        </div>
        <LucideChevronRight className="text-indigo-200" />
      </button>

      {/* å…§å®¹å€å¡Š */}
      {viewMode === 'calendar' ? (
        <div className="bg-white p-8 rounded-[3.5rem] shadow-sm border border-slate-50 animate-in fade-in zoom-in-95 duration-500">
          <div className="flex justify-between items-center mb-10 px-2">
            <button onClick={() => changeMonth(-1)} className="p-3 text-slate-300 hover:text-indigo-500 transition-colors"><LucideChevronLeft size={32} /></button>
            <div className="text-center">
              <p className="text-2xl font-black text-slate-800 tracking-tighter">
                {currentYear} / {String(currentMonth + 1).padStart(2, '0')}
              </p>
            </div>
            <button onClick={() => changeMonth(1)} className="p-3 text-slate-300 hover:text-indigo-500 transition-colors"><LucideChevronRight size={32} /></button>
          </div>

          <div className="grid grid-cols-7 gap-y-6 text-center">
            {["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"].map(d => (
              <div key={d} className="text-[11px] font-black text-slate-300 uppercase">{d}</div>
            ))}
            {calendarDays.map((d, i) => (
              <div 
                key={i} 
                onClick={() => d && openEdit(d)}
                className="aspect-square flex flex-col items-center justify-center relative cursor-pointer"
              >
                {d && (
                  <>
                    <div className={`w-11 h-11 flex items-center justify-center rounded-full text-base transition-all duration-300
                      ${d.drinks.length > 0 ? 'bg-indigo-600 text-white font-bold shadow-lg shadow-indigo-100 scale-105' : 'text-slate-400 hover:bg-slate-50'}
                      ${new Date().toDateString() === new Date(currentYear, currentMonth, d.day).toDateString() ? 'ring-2 ring-indigo-300 ring-offset-2' : ''}
                    `}>
                      {d.day}
                    </div>
                    <div className="h-1.5 mt-2 flex gap-0.5">
                      {d.drinks.slice(0, 3).map((_, idx) => (
                        <span key={idx} className="w-1.5 h-1.5 bg-pink-400 rounded-full"></span>
                      ))}
                    </div>
                  </>
                )}
              </div>
            ))}
          </div>
        </div>
      ) : (
        <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
          <div className="flex items-center justify-between px-6 mb-2">
             <p className="text-[11px] font-black text-slate-400 uppercase tracking-widest">Drink Timeline</p>
          </div>
          {historyList.length === 0 ? (
            <div className="bg-white p-16 rounded-[3rem] text-center text-slate-300 italic text-sm border border-dashed border-slate-100">
              å°šç„¡é£²ç”¨ç´€éŒ„
            </div>
          ) : (
            historyList.map((drink, idx) => (
              <div key={idx} className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-50 flex items-center justify-between group active:scale-[0.98] transition-all">
                <div className="flex items-center gap-5">
                  <div className="w-14 h-14 bg-slate-50 rounded-3xl flex items-center justify-center text-2xl shadow-inner border border-white">
                    {drink.eco ? "â™»ï¸" : "ğŸ¥¤"}
                  </div>
                  <div>
                    <div className="flex items-center gap-2 mb-1">
                      <span className="text-[11px] font-black text-slate-400">{formatDate(drink.date)}</span>
                      <span className="text-[11px] font-bold text-indigo-600 bg-indigo-50 px-2.5 py-0.5 rounded-full">{drink.s}</span>
                    </div>
                    <p className="font-black text-slate-800 text-base leading-tight">{drink.i}</p>
                    <div className="flex gap-2 mt-1.5">
                      <span className="text-[10px] font-bold text-blue-400 bg-blue-50/50 px-2 py-0.5 rounded-md">{drink.ice}</span>
                      <span className="text-[10px] font-bold text-pink-400 bg-pink-50/50 px-2 py-0.5 rounded-md">{drink.sug}</span>
                    </div>
                  </div>
                </div>
                <div className="text-right">
                  <p className="font-black text-emerald-600 text-xl tracking-tighter">${drink.p}</p>
                </div>
              </div>
            ))
          )}
        </div>
      )}

      {/* AI åˆ†æå½ˆçª— */}
      {aiAnalysis && (
        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] flex items-center justify-center p-6">
          <div className="bg-white w-full max-w-md rounded-[3.5rem] p-10 shadow-2xl animate-in zoom-in-95 duration-300">
            <div className="flex justify-between items-center mb-8">
              <div className="bg-indigo-50 p-4 rounded-3xl text-indigo-600 shadow-sm">
                <LucideSparkles size={28} />
              </div>
              <button onClick={() => setAiAnalysis("")} className="text-slate-200 text-5xl hover:text-slate-400 transition-colors">&times;</button>
            </div>
            <h3 className="font-black text-slate-800 text-2xl mb-6 tracking-tight">Gemini é£²å“é¡§å•å›å ±</h3>
            <div className="text-slate-600 leading-relaxed text-base max-h-[50vh] overflow-y-auto pr-2 custom-scrollbar whitespace-pre-wrap">
              {aiAnalysis}
            </div>
            <button 
              onClick={() => setAiAnalysis("")}
              className="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-black mt-10 shadow-xl shadow-indigo-100 active:scale-95 transition-transform"
            >
              æ”¶åˆ°ï¼Œç¹¼çºŒåŠªåŠ›ï¼
            </button>
          </div>
        </div>
      )}

      {/* ç·¨è¼¯ä»‹é¢ */}
      {isModalOpen && (
        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[99] flex items-end">
          <div className="bg-white w-full rounded-t-[4rem] p-10 pb-16 shadow-2xl max-h-[92vh] overflow-y-auto animate-in slide-in-from-bottom-full duration-500">
            <div className="flex justify-between items-start mb-10">
              <div>
                <p className="text-[11px] font-black text-slate-300 uppercase tracking-widest mb-2">Record Date</p>
                <p className="text-3xl font-black text-slate-800 tracking-tighter">
                  {formatDate(activeDayKey)}
                </p>
              </div>
              <button onClick={() => setIsModalOpen(false)} className="text-slate-200 text-6xl">&times;</button>
            </div>

            <div className="space-y-8 mb-10">
              {tempRecords.map((rec, idx) => (
                <div key={idx} className="bg-slate-50/50 p-8 rounded-[3rem] border border-slate-100 relative group">
                  <div className="flex justify-between items-center mb-8">
                     <span className="bg-white px-5 py-2 rounded-full text-[11px] font-black text-slate-300 uppercase shadow-sm">Drink #{idx+1}</span>
                     <button 
                      onClick={() => setTempRecords(prev => prev.filter((_, i) => i !== idx))}
                      className="text-red-200 hover:text-red-500 transition-colors"
                     >
                      <LucideTrash2 size={24} />
                     </button>
                  </div>

                  <div className="grid grid-cols-3 gap-6 mb-8">
                    <div className="col-span-2">
                      <p className="text-[11px] font-black text-slate-400 mb-3 ml-2">åº—å®¶</p>
                      <input 
                        className="w-full bg-white p-5 rounded-[1.5rem] text-base font-black outline-none border-none shadow-sm focus:ring-4 ring-indigo-50 transition-all"
                        value={rec.s} onChange={e => {
                          const n = [...tempRecords]; n[idx].s = e.target.value; setTempRecords(n);
                        }}
                        placeholder="åº—å"
                      />
                    </div>
                    <div>
                      <p className="text-[11px] font-black text-slate-400 mb-3 ml-2">é‡‘é¡</p>
                      <input 
                        className="w-full bg-white p-5 rounded-[1.5rem] text-base font-black outline-none border-none shadow-sm text-center focus:ring-4 ring-indigo-50"
                        type="number" value={rec.p} onChange={e => {
                          const n = [...tempRecords]; n[idx].p = e.target.value; setTempRecords(n);
                        }}
                        placeholder="0"
                      />
                    </div>
                  </div>

                  <div className="mb-8">
                    <p className="text-[11px] font-black text-slate-400 mb-3 ml-2">å“é …</p>
                    <input 
                      className="w-full bg-white p-5 rounded-[1.5rem] text-base font-black outline-none border-none shadow-sm focus:ring-4 ring-indigo-50"
                      value={rec.i} onChange={e => {
                        const n = [...tempRecords]; n[idx].i = e.target.value; setTempRecords(n);
                      }}
                      placeholder="é£²æ–™åç¨±"
                    />
                  </div>

                  <div className="flex justify-between items-center">
                    <button 
                      onClick={() => { const n = [...tempRecords]; n[idx].eco = !n[idx].eco; setTempRecords(n); }}
                      className={`flex items-center gap-3 px-8 py-4 rounded-[1.5rem] text-sm font-black transition-all duration-300
                        ${rec.eco ? 'bg-emerald-500 text-white shadow-xl shadow-emerald-50' : 'bg-white text-slate-300 border border-slate-100'}
                      `}
                    >
                      â™»ï¸ ç’°ä¿æ¯
                    </button>
                    <div className="flex gap-2">
                       <span className="bg-blue-50 text-blue-500 px-4 py-2 rounded-2xl text-[10px] font-black uppercase tracking-tighter">{rec.ice || 'å¾®å†°'}</span>
                       <span className="bg-pink-50 text-pink-500 px-4 py-2 rounded-2xl text-[10px] font-black uppercase tracking-tighter">{rec.sug || 'å¾®ç³–'}</span>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            <button 
              onClick={() => setTempRecords([...tempRecords, { p: "", s: "", i: "", ice: "å¾®å†°", sug: "å¾®ç³–", eco: false }])}
              className="w-full py-7 border-4 border-dashed border-slate-50 rounded-[3rem] text-slate-300 font-black text-lg mb-10 flex items-center justify-center gap-4 active:bg-slate-50"
            >
              <LucidePlus size={28} /> å†å–ä¸€æ¯
            </button>

            <button 
              onClick={saveToCloud}
              className="w-full bg-slate-800 text-white py-7 rounded-[3rem] font-black shadow-2xl flex items-center justify-center gap-4 active:scale-[0.97] transition-all"
            >
              <LucideDatabase size={24} /> å„²å­˜ä¸¦åŒæ­¥è‡³é›²ç«¯ (Cloud)
            </button>
          </div>
        </div>
      )}
    </div>
  );
}