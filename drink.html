<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ§‹ é£²è¨˜ AI çµ‚æ¥µç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html { -webkit-text-size-adjust: 100%; }
        body { 
            width: 100%; margin: 0; padding: 0; background: #F8F9FE; overflow-x: hidden; 
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang TC", "Hiragino Sans GB", "Microsoft JhengHei", sans-serif;
        }
        .app-container { width: 100%; padding: 12px; box-sizing: border-box; }
        .glass-card { background: white; border-radius: 1.5rem; border: 1px solid #EEF0F7; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        
        #date-header { font-size: 1.4rem !important; font-weight: 800 !important; color: #1F2937; letter-spacing: -0.02em; }

        .opt-btn { 
            border: 1px solid #EDF0F7; border-radius: 0.8rem; padding: 10px 0; text-align: center; 
            color: #9CA3AF; background: #F9FAFB; font-size: 0.75rem; font-weight: 600; 
            cursor: pointer; transition: all 0.15s ease; 
        }
        .ice-on { background: #3B82F6 !important; color: white !important; border-color: #3B82F6 !important; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
        .sugar-on { background: #EC4899 !important; color: white !important; border-color: #EC4899 !important; box-shadow: 0 4px 10px rgba(236, 72, 153, 0.3); }
        .eco-on { background: #10B981 !important; color: white !important; border-color: #10B981 !important; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }
        
        .save-btn { 
            background: linear-gradient(135deg, #A855F7 0%, #EC4899 100%); 
            color: white; width: 100%; height: 58px; border-radius: 20px; 
            font-weight: 700; margin-top: 15px; box-shadow: 0 6px 15px rgba(236, 72, 153, 0.3); 
            font-size: 1.1rem; 
        }
        .save-btn:active { transform: scale(0.96); opacity: 0.9; }

        .drink-record-card { border-bottom: 2px dashed #F3F4F6; padding-bottom: 22px; margin-bottom: 22px; }
        .drink-record-card:last-child { border-bottom: none; }
        
        .calendar-day { aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: pointer; z-index: 10; }
        .day-circle { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.9rem; transition: all 0.2s; pointer-events: none; }
        .today-marker { border: 2px solid #A855F7; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .ai-message { animation: slideUp 0.4s ease-out; }
        
        .nav-btn { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; transition: background 0.2s; }
        .nav-btn:active { background: #F3E8FF; transform: scale(0.9); }
    </style>
</head>
<body>
    <div class="app-container">
        <h1 class="text-4xl text-center my-8">ğŸ§‹</h1>
        
        <div class="grid grid-cols-3 gap-2 mb-4 text-center">
            <div class="glass-card p-3"><p class="text-purple-400 text-[9px] font-bold mb-1 uppercase">æœ€æ„›åº—å®¶</p><div id="top-store" class="font-bold text-[11px] truncate text-gray-700 text-xs">å°šæœªç´€éŒ„</div></div>
            <div class="glass-card p-3"><p class="text-pink-400 text-[9px] font-bold mb-1 uppercase">æœ€æ„›å“é …</p><div id="top-item" class="font-bold text-[11px] truncate text-gray-700 text-xs">å°šæœªç´€éŒ„</div></div>
            <div class="glass-card p-3"><p class="text-emerald-500 text-[9px] font-bold mb-1 uppercase">æ¸›å¡‘æˆå°± â™»ï¸</p><div id="eco-count" class="font-bold text-[11px] text-gray-700 text-xs">çœä¸‹ 0 å€‹</div></div>
        </div>
        
        <div class="grid grid-cols-3 gap-2 mb-5 text-center">
            <div class="glass-card py-4"><p class="text-gray-400 text-[10px] mb-1 font-medium">ç¸½æ¯æ•¸</p><p id="total-cups" class="font-bold text-xl text-gray-800 leading-none">0</p></div>
            <div class="glass-card py-4 border-x-2 border-gray-50"><p class="text-gray-400 text-[10px] mb-1 font-medium">ç¸½é‡‘é¡</p><p id="total-cost" class="font-bold text-xl text-emerald-500 leading-none">$0</p></div>
            <div class="glass-card py-4"><p class="text-gray-400 text-[10px] mb-1 font-medium">å¹³å‡åƒ¹</p><p id="avg-price" class="font-bold text-xl text-blue-500 leading-none">$0</p></div>
        </div>

        <div class="mb-5">
            <button onclick="analyzeHabits()" class="w-full bg-white border border-purple-100 p-5 rounded-[1.5rem] flex items-center justify-between shadow-sm active:scale-[0.98]">
                <div class="flex items-center space-x-4">
                    <span class="text-3xl">âœ¨</span>
                    <div class="text-left"><p class="text-[10px] font-bold text-purple-400 uppercase tracking-widest">Gemini é£²å“é¡§å•</p><p class="text-base font-bold text-gray-600">çœ‹æˆ‘çš„é£²å“ç”Ÿæ´»åˆ†æ</p></div>
                </div>
                <span class="text-purple-200 text-xl">â–¶</span>
            </button>
        </div>

        <div class="glass-card p-5 mb-8">
            <div class="flex justify-between items-center mb-6 px-1">
                <div onclick="changeMonth(-1)" class="nav-btn text-purple-300 font-bold text-2xl">â—€</div>
                <span id="calendar-month-year" class="text-base font-bold text-gray-600 tracking-widest">2026 / 01</span>
                <div onclick="changeMonth(1)" class="nav-btn text-purple-300 font-bold text-2xl">â–¶</div>
            </div>
            <div class="grid grid-cols-7 gap-y-3 text-center" id="calendar-grid"></div>
        </div>

        <div class="flex justify-center space-x-8 mb-16 opacity-30 hover:opacity-100">
            <button onclick="exportJSON()" class="text-[11px] font-bold text-gray-400 underline decoration-dotted">å‚™ä»½ç´€éŒ„ (JSON)</button>
            <button onclick="document.getElementById('importFile').click()" class="text-[11px] font-bold text-gray-400 underline decoration-dotted">åŒ¯å…¥ç´€éŒ„</button>
            <input type="file" id="importFile" class="hidden" accept=".json" onchange="importJSON(event)">
        </div>
    </div>

    <!-- AI åˆ†æ Modal -->
    <div id="ai-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center z-[10000] p-6">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-7 shadow-2xl ai-message text-left">
            <div class="flex justify-between items-center mb-5"><h3 class="font-bold text-purple-600 text-lg">âœ¨ æ™ºæ…§é£²å“åˆ†æ</h3><button onclick="closeAiModal()" class="text-gray-300 text-3xl leading-none">&times;</button></div>
            <div id="ai-analysis-content" class="text-gray-600 text-sm leading-relaxed space-y-4 max-h-[55vh] overflow-y-auto">æ­£åœ¨åˆ†æç´€éŒ„ä¸­...</div>
            <button onclick="closeAiModal()" class="w-full bg-purple-600 text-white py-4 rounded-2xl font-bold mt-8">æ”¶åˆ°äº†</button>
        </div>
    </div>

    <!-- ç·¨è¼¯è¦–çª— -->
    <div id="modal-overlay" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end z-[9999]">
        <div class="bg-white w-full rounded-t-[2.5rem] p-6 pb-14 shadow-2xl overflow-y-auto max-h-[92vh]">
            <div class="flex justify-between items-center mb-6 px-1">
                <span id="date-header">2026 / 01 / 01</span>
                <button onclick="closePop()" class="text-gray-300 text-4xl leading-none p-2">&times;</button>
            </div>
            <div class="mb-8">
                <div class="relative">
                    <textarea id="ai-smart-input" placeholder="æ™ºæ…§è¼¸å…¥ï¼šæ˜¨å¤©åœ¨ 50 åµå–äº†æ‹¿éµ 65 å…ƒï¼ŒåŠç³–å°‘å†°ï¼Œç’°ä¿æ¯" class="w-full p-5 rounded-[1.2rem] bg-purple-50 text-sm text-purple-800 font-medium border-none outline-none placeholder-purple-300 resize-none h-24"></textarea>
                    <button id="ai-parse-btn" onclick="smartParseDrink()" class="absolute bottom-3 right-3 bg-purple-500 text-white px-5 py-2.5 rounded-xl text-xs font-bold shadow-md">âœ¨ è‡ªå‹•å¡«å¯«</button>
                </div>
            </div>
            <div id="drinks-list-container"></div>
            <button onclick="addNewDrinkForm()" class="w-full border-2 border-dashed border-purple-100 text-purple-300 py-5 rounded-2xl font-bold text-sm mb-5">+ å†å–ä¸€æ¯</button>
            <button onclick="saveAllToStorage()" class="save-btn">å„²å­˜ä»Šæ—¥æ•¸æ“š</button>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let db = JSON.parse(localStorage.getItem('drink_tracker_ai_v1')) || {};

        // --- Gemini AI ---
        async function callGemini(prompt, sysPrompt = "", schema = null) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: sysPrompt }] } };
            if (schema) payload.generationConfig = { responseMimeType: "application/json", responseSchema: schema };
            const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        async function smartParseDrink() {
            const text = document.getElementById('ai-smart-input').value;
            if (!text.trim()) return;
            const btn = document.getElementById('ai-parse-btn');
            btn.innerText = "è¾¨è­˜ä¸­..."; btn.disabled = true;
            try {
                const schema = { type: "OBJECT", properties: { price: { type: "NUMBER" }, store: { type: "STRING" }, item: { type: "STRING" }, ice: { type: "STRING" }, sugar: { type: "STRING" }, eco_cup: { type: "BOOLEAN" } } };
                const res = await callGemini(`å¾é€™æ®µè©±æå–é£²æ–™è³‡è¨Šï¼š${text}`, "æå–æ‰‹æ–é£²è³‡è¨Šã€‚å†°å¡Šï¼šæ­£å¸¸,å°‘å†°,å¾®å†°,å»å†°,å®Œå»,å¸¸æº«,æº«,ç†±ã€‚ç”œåº¦ï¼šå…¨ç³–,ä¹åˆ†,å°‘ç³–,åŠç³–,å¾®ç³–,äºŒåˆ†,ä¸€åˆ†,ç„¡ç³–ã€‚", schema);
                const data = JSON.parse(res);
                const last = document.querySelector('.drink-record-card:last-child');
                if (data.price) last.querySelector('.price-input').value = data.price;
                if (data.store) last.querySelector('.store-input').value = data.store;
                if (data.item) last.querySelector('.item-input').value = data.item;
                if (data.eco_cup) last.querySelector('.eco-toggle').classList.add('eco-on');
                if (data.ice) last.querySelectorAll('.ice-group .opt-btn').forEach(b => { if(b.innerText === data.ice) b.click(); });
                if (data.sugar) last.querySelectorAll('.sugar-group .opt-btn').forEach(b => { if(b.innerText === data.sugar) b.click(); });
                document.getElementById('ai-smart-input').value = "";
            } catch (e) { alert("æ™ºæ…§è¾¨è­˜å¤±æ•—"); } 
            finally { btn.innerText = "âœ¨ è‡ªå‹•å¡«å¯«"; btn.disabled = false; }
        }

        async function analyzeHabits() {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-analysis-content');
            modal.classList.remove('hidden');
            try {
                const res = await callGemini(`æ•¸æ“šï¼š${JSON.stringify(db)}`, "ä½ æ˜¯å¹½é»˜çš„æ‰‹æ–å°ˆå®¶ï¼Œç”¨ç¹é«”ä¸­æ–‡çµ¦å‡ºåˆ†æã€å»ºè­°èˆ‡é æ¸¬ã€‚");
                content.innerText = res;
            } catch (e) { content.innerText = "åˆ†æç›®å‰ä¸å¯ç”¨ã€‚"; }
        }

        // --- UI é‚è¼¯ ---
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const label = document.getElementById('calendar-month-year');
            grid.innerHTML = '';
            label.innerText = `${currentYear} / ${String(currentMonth + 1).padStart(2, '0')}`;
            const weekDays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
            weekDays.forEach(day => grid.innerHTML += `<div class="text-[10px] text-gray-300 font-bold mb-4 uppercase tracking-widest">${day}</div>`);
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();
            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;
            for (let i = 1; i <= daysInMonth; i++) {
                const key = `${currentYear}${String(currentMonth + 1).padStart(2, '0')}${String(i).padStart(2, '0')}`;
                const drinks = db[key] || [];
                const isToday = today.getFullYear() === currentYear && today.getMonth() === currentMonth && today.getDate() === i;
                grid.innerHTML += `
                    <div class="calendar-day" onclick="openPop(${i})">
                        <div class="day-circle ${drinks.length > 0 ? 'bg-purple-600 text-white font-bold shadow-lg shadow-purple-100' : 'text-gray-500'} ${isToday ? 'today-marker' : ''}">${i}</div>
                        <div class="h-4 flex items-center justify-center">${drinks.length > 1 ? `<span class="text-[9px] text-purple-400 font-bold mt-1.5">${drinks.length}æ¯</span>` : drinks.length === 1 ? `<div class="w-1.5 h-1.5 bg-pink-400 rounded-full mt-2"></div>` : ''}</div>
                    </div>`;
            }
            updateStats();
        }

        function changeMonth(delta) { currentMonth += delta; if (currentMonth > 11) { currentMonth = 0; currentYear++; } else if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderCalendar(); }

        function openPop(day) {
            const m = String(currentMonth + 1).padStart(2, '0');
            const d = String(day).padStart(2, '0');
            const key = `${currentYear}${m}${d}`;
            window.activeDayKey = key;
            document.getElementById('date-header').innerText = `${currentYear} / ${m} / ${d}`;
            const container = document.getElementById('drinks-list-container');
            container.innerHTML = '';
            const existing = db[key] || [];
            if (existing.length > 0) existing.forEach(data => addNewDrinkForm(data));
            else addNewDrinkForm();
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function addNewDrinkForm(data = null) {
            const container = document.getElementById('drinks-list-container');
            const div = document.createElement('div');
            div.className = 'drink-record-card text-left';
            div.innerHTML = `
                <div class="flex justify-between items-center bg-gray-50 p-4 rounded-2xl mb-5">
                    <span class="text-[10px] font-bold text-pink-400 uppercase tracking-widest">é£²å“ç´€éŒ„</span>
                    <div class="flex items-center space-x-3">
                        <div class="opt-btn px-3.5 border-emerald-100 text-emerald-600 eco-toggle ${data && data.eco ? 'eco-on' : ''}" onclick="this.classList.toggle('eco-on')">â™»ï¸</div>
                        <div class="flex items-center"><span class="text-emerald-500 font-bold text-base">$</span><input class="price-input w-20 text-right bg-transparent font-bold text-emerald-600 outline-none text-2xl" type="number" inputmode="numeric" value="${data ? data.p : ''}" placeholder="0"></div>
                        <button onclick="this.closest('.drink-record-card').remove()" class="text-red-300 text-2xl pl-2 active:text-red-500">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-5 text-left">
                    <div class="space-y-1.5"><p class="text-[10px] text-gray-400 font-bold ml-1">åº—å®¶</p><input class="store-input w-full p-4 rounded-xl bg-gray-100 text-sm font-bold outline-none border-none" type="text" placeholder="åº—å" value="${data ? data.s : ''}"></div>
                    <div class="space-y-1.5"><p class="text-[10px] text-gray-400 font-bold ml-1">å“é …</p><input class="item-input w-full p-4 rounded-xl bg-gray-100 text-sm font-bold outline-none border-none" type="text" placeholder="å“é …" value="${data ? data.i : ''}"></div>
                </div>
                <div class="grid grid-cols-4 gap-2 ice-group mb-5">${['æ­£å¸¸','å°‘å†°','å¾®å†°','å»å†°','å®Œå»','å¸¸æº«','æº«','ç†±'].map(o => `<div class="opt-btn ${data && data.ice === o ? 'ice-on' : ''}" onclick="sel(this,'ice')">${o}</div>`).join('')}</div>
                <div class="grid grid-cols-4 gap-2 sugar-group">${['å…¨ç³–','ä¹åˆ†','å°‘ç³–','åŠç³–','å¾®ç³–','äºŒåˆ†','ä¸€åˆ†','ç„¡ç³–'].map(o => `<div class="opt-btn ${data && data.sug === o ? 'sugar-on' : ''}" onclick="sel(this,'sugar')">${o}</div>`).join('')}</div>
            `;
            container.appendChild(div);
        }

        function sel(el, type) { const cls = type === 'ice' ? 'ice-on' : 'sugar-on'; el.parentElement.querySelectorAll('.opt-btn').forEach(b => b.classList.remove(cls)); el.classList.add(cls); }
        function closeAiModal() { document.getElementById('ai-modal').classList.add('hidden'); }
        function closePop() { document.getElementById('modal-overlay').classList.add('hidden'); document.body.style.overflow = 'auto'; }

        function saveAllToStorage() {
            const cards = document.querySelectorAll('.drink-record-card');
            let dataArr = [];
            cards.forEach(c => {
                const p = c.querySelector('.price-input').value;
                if(p) dataArr.push({ p: parseInt(p), s: c.querySelector('.store-input').value || 'æœªè¨˜', i: c.querySelector('.item-input').value || 'æœªå', ice: c.querySelector('.ice-on')?.innerText || 'æ­£å¸¸', sug: c.querySelector('.sugar-on')?.innerText || 'å…¨ç³–', eco: c.querySelector('.eco-toggle').classList.contains('eco-on') });
            });
            db[window.activeDayKey] = dataArr;
            localStorage.setItem('drink_tracker_ai_v1', JSON.stringify(db));
            renderCalendar(); closePop();
        }

        function updateStats() {
            const all = Object.values(db).flat();
            document.getElementById('total-cups').innerText = all.length;
            document.getElementById('total-cost').innerText = `$${all.reduce((s,d)=>s+d.p,0)}`;
            document.getElementById('avg-price').innerText = all.length > 0 ? `$${Math.round(all.reduce((s,d)=>s+d.p,0)/all.length)}` : '$0';
            document.getElementById('eco-count').innerText = `çœä¸‹ ${all.filter(d=>d.eco).length} å€‹`;
            if(all.length > 0) { const last = all[all.length-1]; document.getElementById('top-store').innerText = last.s; document.getElementById('top-item').innerText = last.i; }
        }

        function exportJSON() { const blob = new Blob([JSON.stringify(db)], {type:"application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `é£²æ–™ç´€éŒ„å‚™ä»½.json`; a.click(); }
        function importJSON(e) { const r = new FileReader(); r.onload = (x) => { db = JSON.parse(x.target.result); localStorage.setItem('drink_tracker_ai_v1', JSON.stringify(db)); renderCalendar(); }; r.readAsText(e.target.files[0]); }

        window.onload = renderCalendar;
    </script>
</body>
</html>